name: swis-api CI/CD pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:

  fmt_unit:
    runs-on: [ self-hosted, internal, docker ]
    steps:
    - uses: actions/checkout@v2
    - name: Run tests
      run: make fmt test

  build:
    runs-on: [ self-hosted, internal, docker ]
    needs: [ fmt_unit ]
    steps:
    - uses: actions/checkout@v2
    - name: Build new swapi image (with staging)
      run: make build

  dev_deploy:
    runs-on: [ self-hosted, internal, docker ]
    needs: [ build ]
    steps:
    - uses: actions/checkout@v2
    - name: make error
      run: make 

  dump_data:
    runs-on: [ self-hosted, internal, docker ]
    needs: [ build ]
    steps:
    - name: Dump production data
      run: make dump

  redeploy:
    runs-on: [ self-hosted, internal, docker ]
    needs: [ build, dump_data, dev_deploy ]
    steps:
    - name: Redeploy docker container, recreate container with fresh image
      run: APP_ENVIRONMENT=production make run

  import_data:
    runs-on: [ self-hosted, internal, docker ]
    needs: [ redeploy ]
    steps:
    - name: Import dumped data to production
      run: make import_dump
